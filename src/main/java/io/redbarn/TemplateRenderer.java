package io.redbarn;

import com.google.common.base.Strings;
import com.google.common.collect.Lists;
import jdk.nashorn.api.scripting.ScriptObjectMirror;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.nodes.Node;
import org.jsoup.select.Elements;

import javax.script.ScriptContext;
import javax.script.ScriptEngine;
import javax.script.ScriptException;
import javax.script.SimpleScriptContext;
import javax.servlet.http.HttpServletRequest;
import java.io.IOException;
import java.net.URL;
import java.util.List;

/**
 * Handles logic for rendering Redbarn specific HTML templates.
 *
 * @author Mike Atkisson
 * @since 0.1.0
 */
public class TemplateRenderer {

    private ScriptEngine scriptEngine;

    /**
     * Creates a new instance.
     *
     * @param scriptEngine A Nashorn JavaScript engine used for processing the
     *                     markup with Cheerio and other tools.
     */
    public TemplateRenderer(ScriptEngine scriptEngine) {
        if (scriptEngine == null) {
            var msg = "The 'scriptEngine' argument cannot be null.";
            throw new IllegalArgumentException(msg);
        }

        this.scriptEngine = scriptEngine;
    }

    /**
     * Renders the HTML template modified by the render function found in the
     * template's corresponding JavaScript file.
     *
     * @param templatePath The classpath to the containing markup to be
     *                     modified.
     * @param arguments An array of arguments which should be passed to the
     *                  render function in the template's JavaScript file.
     * @return The HTML markup generated by the render function in the
     *         template's JavaScript file.
     *
     * @throws IllegalArgumentException Thrown when the templatePath argument is
     *                                  null or empty.
     * @throws RedbarnException Thrown when either the template or its
     *                          corresponding JavaScript could not be found in
     *                          the classpath.
     * @throws ScriptException Thrown when Nashorn registers an error.
     */
    public String render(String templatePath, Object[] arguments)
            throws ScriptException {
        if (Strings.isNullOrEmpty(templatePath)) {
            var msg = "The 'templatePath' argument cannot be null or empty.";
            throw new IllegalArgumentException(msg);
        }
        if (!ResourceUtils.exists(templatePath)) {
            var msg = "The specified template '%s' could not be found " +
                         "as a classpath resource.";
            msg = String.format(msg, templatePath);
            throw new RedbarnException(msg);
        }
        String scriptPath = templatePath + ".js";
        if (!ResourceUtils.exists(scriptPath)) {
            var msg = "The specified script '%s' could not be found " +
                    "as a classpath resource.";
            msg = String.format(msg, scriptPath);
            throw new RedbarnException(msg);
        }

        String markup = null;
        try {
            markup = ResourceUtils.getResourceString(templatePath);
            var script = ResourceUtils.getResourceString(scriptPath);
            var args = Lists.newArrayList(arguments);
            Document dom = Jsoup.parse(markup);

            // Set up a new Global context
            var context = new SimpleScriptContext();
            context.setBindings(scriptEngine.createBindings(), ScriptContext.ENGINE_SCOPE);

            // Add objects to the new global context.
            context.setAttribute("console", scriptEngine.get("console"), ScriptContext.ENGINE_SCOPE);
            context.setAttribute("document", dom, ScriptContext.ENGINE_SCOPE);
            scriptEngine.eval("function $(selector) { return document.select(selector); }", context);

            // Set up an artificial 'this' which gets applied to the render method.
            var redbarn = (ScriptObjectMirror) scriptEngine.eval("redbarn = { };", context);
            scriptEngine.eval(script, context);
            var render = (ScriptObjectMirror) scriptEngine.eval("render", context);
            Object rendered = render.call(redbarn, args.toArray());

            if (rendered.toString().equals("undefined")) {
                markup = dom.toString();
            } else {
                var returnOptions = (ScriptObjectMirror) rendered;
                if (returnOptions.hasMember("layout")) {
                    var layoutPath = (String) returnOptions.get("layout");
                    markup = getLayoutMarkup(layoutPath, dom);
                }
            }

            markup = replaceIncludes(markup);
        } catch (IOException e) {
            // Since we checked that these scripts existed already, this should
            // never happen.  It should be safe to ignore this exception.
        }
        return markup;
    }

    private static String getLayoutMarkup(String path, Document partial) throws IOException {
        var markup = ResourceUtils.getResourceString(path);
        Document layout = Jsoup.parse(markup);

        // Replace all elements from the layout with corresponding elements
        // found in the partial.
        Elements identified = partial.select("[id]");
        for (Element content : identified) {
            Element placeHolder = layout.select("[id=\"" + content.id() + "\"]").first();
            if (placeHolder != null) {
                placeHolder.replaceWith(content);
            }
        }

        // Replace any redbarn specific CSS links with one or more corresponding
        // links found in the partial.
        Element linkHolder = layout.select("[type=\"redbarn/css\"]").first();
        if (linkHolder != null) {
            Elements links = partial.select("[type=\"redbarn/css\"]");
            Element previous = linkHolder;
            for (Element link : links) {
                link.removeAttr("type");
                previous.after(link);
                previous = link;
            }
            linkHolder.remove();
        }

        return layout.toString();
    }

    private static String replaceIncludes(String markup) throws IOException {
        Document dom = Jsoup.parse(markup);
        Elements elements = dom.select("[type=\"redbarn/html\"]");
        for (Element element : elements) {
            String path = element.attr("href");
            if (!Strings.isNullOrEmpty(path)) {
                String include = ResourceUtils.getResourceString(path);
                Document document = Jsoup.parseBodyFragment(include);
                element.replaceWith(document.body().child(0));
            }
        }
        return dom.toString();
    }
}
